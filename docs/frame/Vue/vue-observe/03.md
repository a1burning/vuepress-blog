---
title: Vue响应式Q&A
tags: 
  - Vue
date: 2022-1-9
prev: ./02.md
next: false
sidebarDepth: 5
---

## 简答题
### 一、当我们点击按钮的时候动态给 data 增加的成员是否是响应式数据，如果不是的话，如何把新增成员设置成响应式数据，它的内部原理是什么。

```js
let vm = new Vue({
 el: '#el'
 data: {
  o: 'object',
  dog: {}
 },
 method: {
  clickHandler () {
   // 该 name 属性是否是响应式的
   this.dog.name = 'Trump'
  }
 }
})
```

答：增加的成员不是响应式的，要把新增的成员设置成响应式成员。

第一种：可以在data对象中给name进行初始化，初始值设置为空。原理是在页面第一个渲染的时候，Observer类会初始化进行数据劫持，将data添加getter和setter，转化为响应式对象，name如果在开始的时候进行注册，这样在之后修改name的时候，也是响应式的值。

第二种：官网也建议使用Vue.set(object, propertyName, value)方法对新增的属性进行响应式绑定，本质也是使用Object.defineProperty方法，给属性添加getter和setter进行响应式对象的转化。

### 二、给属性重新赋值成对象，是否是响应式的？给 Vue 实例新增一个成员是否是响应式的？

> 给属性重新赋值成对象是响应式的。赋值过程调用Observer的set方法，里面会调用walk方法遍历添加响应式数据。
> 
> 给 Vue 实例新增一个成员不是响应式的，所有的成员是在首页渲染的时候创建的响应式数据，而vm.test = 123 是在后来的设置中创建的，并没有再调用响应式数据的函数。
>
> [vue官网](https://cn.vuejs.org/v2/guide/reactivity.html) 也是这么说的，不允许动态添加根级别的响应式属性，官网的解决方法是Vue.set()，应该是调用了defineReactive方法将属性转换成了getter/setter。

### 三、Vue响应式那个函数去更新视图？

> 首次渲染是Compiler更新视图，更新变化的时候是Watcher更新视图

具体过程：

- Vue
     + 记录传入的选项，设置 `$data/$el`
     + 把 data 的成员注入到 Vue 实例
     + 负责调用 Observer 实现数据响应式处理（数据劫持）
     + 负责调用 Compiler 编译指令/插值表达式等
- Observer
     + 数据劫持
     + 负责把 data 中的成员转换成 getter/setter
     + 负责把多层属性转换成 getter/setter
     + 如果给属性赋值为新对象，把新对象的成员设置为 getter/setter
     + 添加 Dep 和 Watcher 的依赖关系
     + 数据变化发送通知
- Compiler
     + 负责编译模板，解析指令/插值表达式
     + 负责页面的首次渲染过程
     + 当数据变化后重新渲染
- Dep
     + 收集依赖，添加订阅者(watcher)
     + 通知所有订阅者
- Watcher
     + 自身实例化的时候往dep对象中添加自己
     + 当数据变化dep通知所有的 Watcher 实例更新视图

## 编程题

### 一、在模拟 Vue.js 响应式源码的基础上实现 v-html 指令，以及 v-on 指令。

见code/vue-data文件夹
v-on只实现了methods中定义函数，未处理参数部分。